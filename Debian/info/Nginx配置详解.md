# Nginx 配置详解

> 用好 Nginx，需要掌握的知识会非常多，而我们只会详细讲解常用部分，其它可以参考[Nginx 官方手册](http://nginx.org/en/docs/)

## Nginx 模块化体系结构

> nginx 的内部结构是由核心部分和一系列的功能模块所组成。

```text
- 这样划分是为了使得每个模块的功能相对简单，便于开发，同时也便于对系统进行功能扩展；
- 为了便于描述，下文中我们将使用 “Nginx core” 来称呼 Nginx 的核心功能部分。
```

### Nginx core

> `Nginx core` 提供了 web 服务器的基础功能，同时提供了 web 服务反向代理，email 服务反向代理功能。

```text
- Nginx core 实现了底层的通讯协议，为其他模块和 Nginx 进程构建了基本的运行时环境，并且构建了其他各模块的协作基础。
- 除此之外，或者说大部分与协议相关的，或者应用相关的功能都是在这些模块中所实现的。
```

### 模块概述

```text
nginx将各功能模块组织成一条链，当有请求到达的时候，请求依次经过这条链上的部分或者全部模块，进行处理。每个模块实现特定的功能。
    - 例如，实现对请求解压缩的模块，实现SSI的模块，实现与上游服务器进行通讯的模块，实现与FastCGI服务进行通讯的模块。
有两个模块比较特殊，他们居于nginx core和各功能模块的中间。
    - 这两个模块就是http模块和mail模块。
    - 这2个模块在nginx core之上实现了另外一层抽象，处理与HTTP协议和email相关协议（SMTP/POP3/IMAP）有关的事件;
    - 并且确保这些事件能被以正确的顺序调用其他的一些功能模块。
目前HTTP协议是被实现在http模块中的，但是有可能将来被剥离到一个单独的模块中，以扩展nginx支持SPDY协议。
```

### 模块的分类

> nginx 的模块根据其功能基本上可以分为以下几种类型：

1. event module:

   ```text
   - 搭建了独立于操作系统的事件处理机制的框架，及提供了各具体事件的处理。
   - 包括ngx_events_module， ngx_event_core_module和ngx_epoll_module等。nginx具体使用何种事件处理模块，这依赖于具体的操作系统和编译选项。
   ```

2. phase handler:

   ```text
   - 此类型的模块也被直接称为handler模块。
   - 主要负责处理客户端请求并产生待响应内容，
        - 比如ngx_http_static_module模块，负责客户端的静态页面请求处理并将对应的磁盘文件准备为响应内容输出。
   ```

3. output filter:

   ```text
   - 也称为filter模块，主要是负责对输出的内容进行处理，可以对输出进行修改。
   - 例如，可以实现对输出的所有html页面增加预定义的footbar一类的工作，或者对输出的图片的URL进行替换之类的工作。
   ```

4. upstream:

   ```text
   - upstream模块实现反向代理的功能，将真正的请求转发到后端服务器上，并从后端服务器上读取响应，发回客户端。
   - upstream模块是一种特殊的handler，只不过响应内容不是真正由自己产生的，而是从后端服务器上读取的。
   ```

5. load-balancer:

   ```text
   - 负载均衡模块，实现特定的算法，在众多的后端服务器中，选择一个服务器出来作为某个请求的转发服务器。
   ```
