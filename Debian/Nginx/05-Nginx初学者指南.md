# Nginx 初学者指南

> 本指南提供了对 nginx 的基本介绍，并介绍了可以使用它完成的一些简单任务。

## 启动，停止和重新加载配置

1. 启动 Nginx

   > 要启动 nginx，请运行可执行文件。使用以下语法：

   ```shell
   $ nginx
   ```

2. nginx 指令信号

   > 启动 nginx 后，可以通过使用-s 参数调用可执行文件来控制它。使用以下语法：

   ```shell
   $ nginx -s 信号
   ```

   > 可选信号列表

   | 信号            | 描述             |
   | --------------- | ---------------- |
   | nginx -s stop   | 快速关闭         |
   | nginx -s quit   | 优雅的关闭       |
   | nginx -s reload | 重新加载配置文件 |
   | nginx -s reopen | 重新打开日志文件 |

3. 信号详解

   > 例如，要停止 nginx 进程，等待 worker 进程完成服务当前请求，可以执行以下命令:

   ```shell
   # 这个命令应该在启动 nginx 的同一用户下执行。
   $ nginx -s quit
   ```

   - 借助 kill 实用程序，将信号发送到 nginx 进程

   ```text
   - kill 指令可以将信号直接发送到具有给定进程ID的进程
   - 默认情况下，nginx主进程的进程ID写入目录 /usr/local/nginx/logs 或 /var/run 中的 nginx.pid
   - 例如，如果主进程(master)ID是1628，要通过kill指令发送让nginx正常关闭的QUIT信号，请执行：
        $ kill -s QUIT 1628
   ```

   > 要获取所有正在运行的 nginx 进程的列表，ps 可以使用该实用程序，例如，通过以下方式：

   ```shell
   $ ps -ax | grep nginx
   ```

## Nginx 架构

> Nginx 服务器灵活强大的功能扩展特性是其巨大的优势。架构是一门学问，尤其对 Nginx 这种优秀的软件，更是需要在长期的世界中不断学习和总结。

### Nginx 服务器架构

> Nginx 服务器启动后，产生一个主进程（master process），主进程执行一系列工作后产生一个或者多个工作进程（worker process）。

```text
- 主进程主要进行 Nginx 配置文件解析、数据结构初始化、模块配置和注册、信号处理、网络监听生成、工作进程生成和管理等过早；
- 工作进程主要进行进程初始化、模块调用和请求处理等工作，是 Nginx 服务器提供服务的主体。
- 在客户端请求动态站点的过程中，Nginx 服务器还涉及和后端服务器的通信。
    - Nginx 服务器将会接收到 Web 请求通过代理转发到后端服务器，由后端服务器进行数据处理和页面组织，然后将结果返回。
- 另外，Nginx 服务器为了提高对请求的相应效率，进一步降低网络压力，采用了缓存机制，将历史应答数据缓存到本地。
    - 在每次 Nginx 服务器启动后的一段时间内，会启动专门的进程对本地缓存的内容重建索引，保证对缓存文件的快速访问。
- 根据上面的分析，可以将 Nginx 服务器的大致结构分为主进程、工作进程、后端服务器和缓存等部分。
```

### Nginx 服务器的进程

> 到目前为止，一共提到 Nginx 服务器的三大类进程：一类是主进程，另一类是主进程生成的工作进程，最后一类为用于缓存文件创建索引的进程。

1. 主进程（Master Process）

   > Nginx 服务器启动时运行的主要进程。它的主要功能是与外界通信和对内部其他进程进行管理，具体来说有以下几点：

   ```text
   1）读取 Nginx 配置文件并验证其有效性和确定性。
   2）建立、绑定和关闭 Socket。
   3）按照配置生成、管理和结束工作进程。
   4）接受外界指令，比如重启、升级及退出服务器指令。
   5）不中断服务，实现平滑重启，应用新配置。
   6）不中断服务，实现平滑升级，升级失败进行回滚处理。
   7）启动日志文件，获取文件描述符。
   8）编译和处理 Perl 脚本。
   ```

2. 工作进程（Work Process）

   > worker 进程由主进程生成，生成数量可以通过 Nginx 配置文件指定，正常情况下生存于主进程的整个生命后期。该进程的主要工作有以下几项：

   ```text
   1）接受客户端请求。
   2）将请求依次送入各个功能模块进行过滤处理。
   3）IO 调用，获取相应数据。
   4）与后端服务器通信，接受后端服务器处理结果。
   5）数据缓存，访问缓存索引、查询和调用缓存数据。
   6）发送请求结果，响应客户端请求。
   7）接收主程序指令，比如重启、升级和退出等指令。
   ```

   ```text
   - 工作进程完成的任务还有很多，在这里列出了重要的几项。
   - 从这些工作中可以看到，该进程是 Nginx 服务器提供 Web 服务、处理客户端请求的主要进程，完成了 Nginx 服务器的主体工作。
   - 因此，在实际使用中，作为服务器管理者，应该重点监视工作进程的运行状态，保证 Nginx 服务器对外提供问题的 Web 服务。
   ```

3. 缓存索引重建及管理进程（Cache Loader & Cache Manager）

   > Cache 模块，主要由缓存索引重建（Cache Loader）和缓冲索引管理（Cache Manager）两类进程完成工作。

   ```text
   - '缓存索引重建进程'是在 Nginx 服务启动一段时间之后（默认是 1 分钟）由主进程生成，在缓存元数据重建完成后就自动退出；
   - '缓存索引管理进程'一般存在于主进程的整个生命周期，负责对缓存进行管理。
   - '缓存索引重建进程'完成的主要工作是，根据本地磁盘上的缓存文件在内存中建立索引元数据库。
       - 该进程启动后，对本地磁盘上存放缓存文件的目录结构进行扫描，检查内存中已有的缓存元数据是否正确，并更新索引元数据库。
   - '缓存索引管理进程'主要负责在索引元数据更新完成后，对元数据是否过期作出判断。
   - 这两个进程维护的内容索引元数据，为工作进程对缓存数据的快速查询提供了便利。
   ```

### 进程交互

> Nginx 服务器使用 Master-Worker 模型时，会涉及主进程和工作进程（Master-Worker）之间的交互和工作进程（Worker-Worker）之间的交互。这两类交互都依赖于管道（channel）机制。交互的准备工作都是在工作进程生成时完成的。

1. Master-Slave 交互

   ```text
   工作进程是由主进程生成的（使用了 fork 函数）。
       - Nginx 服务器启动以后，主进程根据配置文件决定生成的工作进程的数量，然后建立一张全局的工作进程表用于存放当前未退出的所有工作进程。
   在主进程生成工作进程后，将新生成的工作进程加入到工作进程表中，并建立一个单向管道并将其传递给该工作进程。
       - 该管道与普通的管道不同，它是由主进程指向工作进程的单向管道，包含了主进程向工作进程发出的指令、工作进程 ID、工作进程在工作进程表中的索引和必要的文件描述符等信息。
   主进程与外界通过信号机制进行通信，当接收到需要处理的信号时，它通过管道向相关的工作进程发送正确的指令。
       - 每个工作进程都有能力捕获管道中可读事件，当管道中有可读事件时，工作进程从管道读取并解析指令，然后采取相应的措施。这样就完成了 Master-Worker 的交互。
   ```

2. Worker-Worker 交互

   ```text
   Worker-Worker 交互实现原理和 Master-Worker 交互基本上是一样的。
       - 只要工作进程之间能够得到彼此的信息，建立管道，即可通信。
       - 由于工作进程之间是相互隔离的，因此一个进程要知道另一个进程的信息，只能过程主进程来设置了。
   为了达到工作进程之间交互的目的：
       - 主进程在生成工作进程后，在工作进程表中进行遍历，将该新进程的 ID 以及针对该进程建立的管道句柄传递给工作进程表中的其他进程，为工作进程之间的交互做准备。
       - 每个工作进程捕获管道中可读事件，根据指令采取响应的措施。
   当工作进程 W1 需要向 W2 发送指令时：
       - 首先在主进程给它的其他工作进程信息中找到 W2 的进程 ID，然后将正确的指令写入指向 W2 的通道。
       - 工作进程 W2 捕获到管道中的事件后，解析指令并采取相应措施。
       - 这样就完成了 Worker-Worker 交互。
   ```

### Run Loops 事件处理循环模型

> Run Loops 指得是进程内部用来不停地调配工作，对事件进行循环处理的一种模型。它属于进程或者线程的基础架构部分。

```text
- 该模型对事件的处理不是自动的，需要在设计代码过程中，在适当的时候启动 Run-Loop 机制对输入的事件作出相应。
- 该模型是一个集合，集合中的每一个元素称为一个 Run-Loop。
    - 每个 Run-Loop 可运行在不同的模式下，其中可以包含它所监听的输入事件源、定时器以及在事件发生时需要通知的 Run-Loop 监听器（Run-Loop Observers）。
    - 为了监听特定的事件，可在 Run Loops 中添加相应的 Run-Loop监听器。
    - 当被监听的事件发生时，Run-Loop 会产生一个消息，被 Run-Loops 监听器捕获，从而执行预定的动作。
- Nginx 服务器在工作进程中实现了 Run-Loop 事件处理循环模型的使用，用来处理客户端发来的请求事件。
    - 该部分的实现可以说是 Nginx 服务器程序实现中最为复杂的部分，包含了对输入事件繁杂的响应和处理过程，并且这些处理过程都是基于异步任务处理的。
```

## Nginx 配置文件

> nginx 由模块组成，这些模块由配置文件中指定的指令控制。

```text
- 指令分为简单指令和块指令：
    - 一个简单的指令由名称和参数组成用空格分隔，以分号结尾（;）
    - 块指令与简单指令具有相同的结构，但它不是以分号结尾，而是以大括号（ { 和 } ）包围的一组附加指令结束。
        - 如果块指令可以在大括号内包含其他指令，则称其为上下文
- 在任何上下文之外放置在配置文件中的指令都被认为是 `main 上下文` 的指令，如：
    - events 和 http 块指令驻留在 main 上下文中；
    - server 块指令位于 http 上下文中；
    - location 块指令位于 server 上下文中。
```

> Nginx 配置文件结构大致如下：

```text
## =============================================================================
##                              【Nginx 配置文件结构】
## =============================================================================
├─ main                                     核心，配置影响nginx全局的指令
|   ├─events                                配置影响nginx服务器或与用户的网络连接
|   |
|   ├─stream                                处理网络通信协议的第4层(tcp/udp)
|   |  ├─upstream                           4层负载均衡
|   |  ├─server                             4层代理、4层反向代理
|   |  └─ ...
|   |
|   ├─http                                  处理网络通信协议的第7层(tcp/ip)
|   |  ├─upstream                           7层负载均衡
|   |  ├─server                             虚拟主机、7层代理、7层反向代理
|   |  |  ├─location                        配置请求的路由，以及各种页面的处理情况。
|   |  |  └─ ...
|   |  └─ ...
|   |
|   ├─mail                                  代理邮箱服务器
|   |  ├─server
|   |
|
└─
```

### 核心（main 上下文）

> 配置影响 nginx 全局的指令，一般来讲 [main 指令集](./module/main指令集.md) 里的指令都允许写在核心区域上。

### events 上下文

> 配置影响 nginx 服务器或与用户的网络连接。有每个进程的最大连接数，选取哪种事件驱动模型处理连接请求，是否允许同时接受多个网路连接，开启多个网络连接序列化等。

### stream 上下文

> 处理网络通信中的 第 4 层协议（TCP/UDP），如：4 层代理、4 层反向代理、4 层负载均衡

- upstream 上下文

  > 处理 `IP+端口` 的负载均衡

- server 上下文

  > 处理 `IP+端口` 代理以及反向代理

### http 上下文

> 处理 `http/https协议` 的指令都在这里，`http上下文` 拥有的子模块非常多

```text
- http上下文,可以嵌套多个 server，配置代理，缓存，日志定义等绝大多数功能和第三方模块的配置。
- 如文件引入，mime-type 定义，日志自定义，是否使用 sendfile 传输文件，连接超时时间，单连接请求数等。
```

- upstream 上下文

  > 处理 `HTTP/HTTPS` 的负载均衡

- server 上下文

  > 配置虚拟主机的相关参数，一个 `http上下文` 中可以有多个 `server块`。

- location 上下文

  > 配置请求的路由，以及各种页面的处理情况。

### mail 上下文

> 处理 Nginx 服务器的邮件服务

- server 上下文

> 关于 Nginx 配置文件的具体配置请查看 [Nginx 配置案例](./06-Nginx配置案例.md)
