# 新建与合并分支（一个实例）

> 前面的讲解，让大家对 Git 分支有了大概理解，现在我们会用一个实例更加形象地去解说， Git 分支是如何帮助我们完成工作的！

## 这是本项目的一次实践演习

> 1.  该项目发布到 github 上后，已经有人在浏览
> 2.  为了 master 仓库项目的稳定，我们决定创建一个分支（ `dev3` ）
> 3.  以后都会先在 `dev3` 这个分支编辑内容，如果感觉可以了再让 `master` 合并分支
> 4.  有时浏览者发现我写的内容又错误，热心肠的就会通过 github 平台向我发起疑惑
> 5.  这时候我就会从 `dev3` 切换到 `master`
> 6.  跟 `master` 相同快照版本上创建一个解决 `浏览器发现的错误` 的修补分支( `bug1` )
> 7.  在解决了之后，切换回线上分支（ master ），然后合并这个 `bug1` 分支
> 8.  最后切换回 `dev3` 继续完成本项目的后续工作，我们后续的工作也都会在 `dev3` 分支里完成！

### 第一步：新建 `dev3` 分支，并切换到该分支

> 切换前，请确保已经提交所有修改！

```shell
$ git status -s
 M 3.02-新建与合并分支（一个实例）.md
$ git commit -a -m '提交所有修改，准备创建一个新分支 dev3'
[master f6153f8] 提交所有修改，准备创建一个新分支 dev3
  1 file changed, 17 insertions(+)
$ git push
Counting objects: 6, done.
Delta compression using up to 4 threads.
Compressing objects: 100% (6/6), done.
Writing objects: 100% (6/6), 1.20 KiB | 613.00 KiB/s, done.
Total 6 (delta 3), reused 0 (delta 0)
remote: Resolving deltas: 100% (3/3), completed with 3 local objects.
To https://github.com/linjialiang/programmer.git
   2dd1f67..f6153f8  master -> master
$ git checkout -b dev3
Switched to a new branch 'dev3'
$ git branch
* dev3
  master
  testing
```

> 到此我们的工作就已经开始在 `dev3` 分支进行了！
>
> -   注意到没，从这里看来，我们上节课漏删了 `testing` 分支，下面我们就来删除它

```shell
$ git branch --delete testing
Deleted branch testing (was f5c3963).
```

> `dev3` 这个新创建的分支在远程上并没有，我们需要将它推送到远程仓库
>
> -   `git push github-programmer dev3` 指令可以推送本地分支（打标签的相关指令和分支类似）

```shell
$ git commit -a -m '推送本地分支 dev3 前，提交修改的数据'
$ git push github-programmer dev3
```

### 删除多余的远程分支

> 使用 `git branch -a` 可以查看所有本地分支和远程分支
>
> -   使用 `git branch -r` 可以只查看远程分支

```shell
$ git branch -r
  github-programmer/HEAD -> github-programmer/master
  github-programmer/dev
  github-programmer/dev2
  github-programmer/dev3
  github-programmer/master
```

> 在公司查看是正常的，但是回到家里，我们查看远程分支，发现 `dev` 虽然删除了，但是依然在记录里
>
> -   我们使用 `git remote show <remote-name>` 指令可以查看remote地址，远程分支，还有本地分支与之相对应关系等信息

```shell
$ git remote show github-programmer
* remote github-programmer
  Fetch URL: https://github.com/linjialiang/programmer.git
  Push  URL: https://github.com/linjialiang/programmer.git
  HEAD branch: master
  Remote branches:
    dev2                               tracked
    dev3                               tracked
    master                             tracked
    refs/remotes/github-programmer/dev stale (use 'git remote prune' to remove)
  Local branches configured for 'git pull':
    dev3   merges with remote dev3
    master merges with remote master
  Local refs configured for 'git push':
    dev3   pushes to dev3   (up to date)
    master pushes to master (up to date)
```

> 根据提示，告诉我们使用 `git remote prune <remote-name>` 命令来清除 `指定的远程仓库里不存在的分支` 的记录
>
> -   该指令必须加上 `<remote-name>`

```shell
$ git remote prune github-programmer
Pruning github-programmer
URL: https://github.com/linjialiang/programmer.git
 * [pruned] github-programmer/dev
```

> 我们发现 `dev3` 分支不能像 `master` 一样使用 `git [push|pull]`，需要使用 `git [push|pull] github-programmer dev3` 才能推送和获取远程仓库数据
>
> -   使用 `git branch --set-upstream-to=<remote-name>/<remote-branch> <local-branch>` 指令，将远程分支和本地分支绑定后就能使用 `git [push|pull]` 了

```shell
$ git branch --set-upstream-to=github-programmer/dev3 dev3
Branch 'dev3' set up to track remote branch 'dev3' from 'github-programmer'.
$ git pull
Already up to date.
$ git push
Everything up-to-date
```

> 我正在写的时候，github 发邮箱提醒我，有个读者向我提了个BUG大致是说：
>
> -   在 `2.06-为 Git 打标签.md` 这个小节中有一句错误的说明
> -   位置在 113 行，内容是:

```md
\> -   注意：这么做，应该新建一个本地仓库，再获取特定 Git 标签的数据，来作为新的分支
```

> 现在我要回到 `master` 分支去处理这件事情了
>
> -   回去之前我要先将 `dev3` 分支的修改全部提交上去

```shell
$ git commit -a -m '为了解决 issues1 问题，回到 master 前做一次提交操作'
```

```shell
$ git checkout master
error: unable to create file program-basic/git/03-Git-Branching/3.02-新建与合并分支（一个实例）.md: Permission denied
Switched to branch 'master'
D       program-basic/git/03-Git-Branching/3.02-新建与合并分支（一个实例）.md
Your branch is up to date with 'github-programmer/master'.
```

1.  我们发现切换到 master 分支后，有文件被莫名删除了，这该如何是好呢？

    > -   原因：是 git 没有权限操作该文件（比如该文件正在被使用中），这时候就会导致冲突的文件直接被删除
    > -   忠告：切换前需要做好准备，不要让文件处于 git 无法操作的状态

2.  解决方式：

    > 1.  先合并再切换-不可取（因为 `dev3` 内容有待测试）;
    > 2.  使用 `git checkout -- <file>...` 来恢复文件（可以使用，但是如果不将文件状态处理好，切换到 `dev3` 又会出这类问题）；
    > 3.  将文件状态处理好，给换到分支 `dev3` 再切换回 `master` （可取）。
    > 4.  权衡利弊我们选择了 方式三：

    ```shell
    $ git checkout dev3
    Switched to branch 'dev3'
    Your branch is ahead of 'github-programmer/dev3' by 4 commits.
      (use "git push" to publish your local commits)
    ```

    ```shell
    $ git checkout master
    Switched to branch 'master'
    Your branch is up to date with 'github-programmer/master'.
    ```

> 好了，现在没毛病了，我们要开始修复 `issues1` 这个错误了；
>
> -   修复前，我们要新建 `issues1` 分支，等解决了这个 `bug` 后我们在切换回 `master`
> -   在 `master` 分支，发起对 `issues1` 分支的合并命令（ `git merges <branche>` ）

```shell
$ git checkout -b issues1
...
$ vim */git/*/2.06-*.md
...
$ git add */git/*/2.06-*.md
$ git commit -m '解决了 issues1 分支上的错误注释，感谢热心朋友的提醒，接下来我们要切换回 master 分支做合并了'
...
```

```shell
$ git checkout master
Switched to branch 'master'
Your branch is up to date with 'github-programmer/master'.
$ git merge issues1
Updating 18bb931..feebc9a
Fast-forward
 program-basic/git/02-Git-Basics/2.06-为 Git 打标签.md | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)
```

> 在这里你会发现 `git merge` 合并的时候，并没有遇到冲突，这是为什么呢？
>
> -   由于当前 `master` 分支所指向的提交是 `issues1` 的直接上游，所以 Git 直接用了 `快进（fast-forward）` ，简单的将指针向前移动即可。
> -   接下来我们就是提交上远程仓库，并且删除不必要的分支 `issues1` ，最后切换到 `dev3` 分支继续未完成工作！

```shell
$ git push
Counting objects: 6, done.
Delta compression using up to 4 threads.
Compressing objects: 100% (6/6), done.
Writing objects: 100% (6/6), 807 bytes | 403.00 KiB/s, done.
Total 6 (delta 4), reused 0 (delta 0)
remote: Resolving deltas: 100% (4/4), completed with 4 local objects.
To https://github.com/linjialiang/programmer.git
   18bb931..feebc9a  master -> master
```

> 知识点： `git push` 并不会向远程仓库提交 `标签` 和 `其它分支`，它只会提交 `当前分支` 的修改内容

```shell
$ git checkout dev3
Switched to branch 'dev3'
Your branch is ahead of 'github-programmer/dev3' by 5 commits.
  (use "git push" to publish your local commits)
```

```shell
$ git branch --delete issues1
error: The branch 'issues1' is not fully merged.
If you are sure you want to delete it, run 'git branch -D issues1'.
```

> 大家发现了吗，在这里又报错了，意思是说： `issues1` 分支上有未完成的合并问题
>
> -   当然如果你确定要删除，就直接使用 `git branch -D issues1` 指令，强制删除
> -   我们建议大家，先回到 `master` 操作，这样做有个好处，如果真有未解决的合并问题存，我们可以再次修改，再次提交！

```shell
$ git checkout master
Switched to branch 'master'
Your branch is up to date with 'github-programmer/master'.
$ git branch --delete issues1
Deleted branch issues1 (was feebc9a).
```

> 这里没有未解决的合并问题，直接删除的 `issues1` 分支，现在我们切换到 `dev3` 继续工作吧

```shell
$ git checkout dev3
Switched to branch 'dev3'
Your branch is ahead of 'github-programmer/dev3' by 6 commits.
  (use "git push" to publish your local commits)
```

> 好了，到此我们的例子已经完成，确认内容的正确性后，我们现在准备跟 master 合并，并发布到 github 远程仓库！

### 合并到 master 并发布到 github 远程仓库

```shell
$ git commit -a -m '合并到 master 前的提交'
...
$ git push
...
$ git checkout master
...
$ git merge dev3
...
```

> 解决合并冲突并提交

```shell
$ git add <file>...
$ git commit -m 'master 合并 dev3 后做的提交'
...
$ git push
```

> master 分支发布新版本后我们可以为它打标签
>
> -   我们使用附注标签

```shell
$ git tag -a v3.0.1-beta -m '内容更新到 */git/*/3.02-*.md'
...
$ git push github-programmer v3.0.1-beta
...
```

> 最后我们重新回到 dev3 版本继续更新未完成的内容！

```shell
$ git checkout dev3
```
